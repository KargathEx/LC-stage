ã€ æš´åŠ›ã€å­—ç¬¦ä¸²ç¼–ç ã€Zå‡½æ•° ã€ä¸‰ç§è§£æ³•è¯¦è§£


### è§£é¢˜æ€è·¯

**æ–¹æ³•ä¸€ï¼šæš´åŠ›åŒ¹é… + äºŒåˆ†**

ä»åå¾€å‰æšä¸¾ $s_m$ ï¼ˆ$s_m$ è¡¨ç¤ºé•¿åº¦ä¸º $i$ çš„å­—ç¬¦ä¸²ï¼Œ$s=s_n$ï¼‰ï¼Œå…ˆè¿›è¡Œç®€å•çš„åˆ¤æ–­ï¼š
* è‹¥ $s_m[0]  \neq s[0]$ï¼Œåˆ™ $s_m$ ä¸ $s$ ä¸ä¼šå­˜åœ¨å…¬å…±å‰ç¼€ï¼Œå¾—åˆ†ä¸º $0$ï¼› `ï¼ˆå¤§éƒ¨åˆ†å­—ç¬¦ä¸²ä¸å­˜åœ¨å…¬å…±å‰ç¼€ï¼Œæ­¤ä¸¾å¯åŠ é€Ÿè¿ç®—ï¼‰`
* è‹¥ $s_m[0]  = s[0]$ï¼Œå¯è¿›ä¸€æ­¥åŸºäº **äºŒåˆ†æœç´¢** æ‰¾åˆ°æœ€é•¿çš„å…¬å…±å‰ç¼€ï¼š
    *  äºŒåˆ†æœç´¢åˆå§‹åŒ– $left = 0, right = m+1, mid = (left+right) // 2$
    * åˆ¤æ–­ $s_m$ çš„å‰ $mid$ é¡¹æ˜¯å¦ä¸ $s$ çš„å‰ $mid$ é¡¹ä¸€æ ·ï¼š
        * è‹¥ $s[n-m:n-m+mid]=s[:mid]$ï¼Œå°è¯•æ‰©å¤§æœç´¢èŒƒå›´ï¼š$left = mid+1$ï¼› `ï¼ˆå¾€å³æœç´¢ï¼‰`
        * å¦åˆ™ï¼Œç¼©å°æœç´¢èŒƒå›´ $right = mid$ï¼›
    * æœ€ç»ˆï¼Œ$s_m$ çš„å¾—åˆ†ä¸º $left-1$ã€‚`ï¼ˆäºŒåˆ†æœç´¢å¾€å³æœç´¢çš„ç‰¹æ€§ï¼‰`


>âš ï¸ è¿™ç§æ–¹æ³•åœ¨åŒ¹é…å­—ç¬¦ä¸²æ—¶è¿‡äºæš´åŠ›ï¼Œåœ¨æµ‹è¯•ç”¨ä¾‹ä¸­å¡åœ¨äº†ç¬¬ $140$ ä¸ªç”¨ä¾‹ä¸Šï¼Œå³ $100000$ ä¸ª `a`ã€‚
å……åˆ†å‘æŒ¥ã€Šé¢å‘æµ‹è¯•ç”¨ä¾‹çš„ç¼–ç¨‹ã€‹ç²¾ç¥ï¼Œå¯¹äºè¯¥ç”¨ä¾‹ç‰¹æ®Šå¤„ç†å³å¯æš´åŠ›é€šè¿‡å…¨éƒ¨143ä¸ªç”¨ä¾‹ã€‚ğŸ¤£

![contest.png](https://pic.leetcode-cn.com/1649049030-rCjLfq-contest.png){:width=400}

&nbsp;



#### ä»£ç 

```Python3 []
class Solution:
    def sumScores(self, s: str) -> int:
        
        n = len(s)
        if len(set(s)) == 1:        # é¢å‘æµ‹è¯•ç”¨ä¾‹ï¼š100000ä¸ª'a'
            return n * (n + 1) // 2
        
        ans = n                     # å­—ç¬¦ä¸²sæœ¬èº«æ»¡è¶³è¦æ±‚
        for m in range(1, n):       # æšä¸¾siçš„é•¿åº¦m
            if s[n-m] != s[0]:      # å¿«é€Ÿç®€å•åˆ¤æ–­ï¼šs[n-m]æ˜¯é•¿åº¦ä¸ºmçš„åç¼€å­—ç¬¦ä¸²çš„é¦–å­—æ¯
                continue
            left, right = 0, m + 1  # äºŒåˆ†æ¨¡æ¿
            while left < right:
                mid = (left + right) // 2
                if s[:mid] == s[n-m:n-m+mid]:
                    left = mid + 1      # è‹¥æˆç«‹ï¼Œå°è¯•å¢å¤§å­—ç¬¦é•¿åº¦: å¾€å³æŸ¥æ‰¾ã€bisect_rightã€‘
                else:
                    right = mid
            
            ans += left-1     # bisect_rightæœç´¢ç‰¹æ€§ï¼šleftæ­¤æ—¶å¹¶ä¸å¯è¡Œï¼Œåº”è¿”å›left-1
        
        return ans
```


&nbsp;

---

**æ–¹æ³•äºŒï¼šå­—ç¬¦ä¸²ç¼–ç   + äºŒåˆ†**

æ–¹æ³•ä¸€åœ¨å­—ç¬¦ä¸²åŒ¹é…ä¸Šæµªè´¹äº†å¤ªå¤šæ—¶é—´ï¼Œæ›´ä¸ºé€šç”¨çš„æ–¹æ³•ä¸º **å­—ç¬¦ä¸²ç¼–ç **ã€‚

å­—ç¬¦ä¸²ç¼–ç çš„ç†è®ºåŸºç¡€å¯å‚è€ƒé¢˜ç›® **1392. æœ€é•¿å¿«ä¹å‰ç¼€**ï¼š

| é¢˜å· |  é¢˜è§£ | éš¾åº¦ |
| :-----| :---- | :----: |
| 1392. æœ€é•¿å¿«ä¹å‰ç¼€ |  [å®˜æ–¹é¢˜è§£é“¾æ¥](https://leetcode-cn.com/problems/longest-happy-prefix/solution/zui-chang-kuai-le-qian-zhui-by-leetcode-solution) | å›°éš¾ |

&nbsp;
ä¸€èˆ¬åœ°ï¼Œä¸€ä¸ªå­—ç¬¦ä¸² $s$ çš„ç¼–ç å€¼è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

$$encode(s) = \sum_{i=0}^{|s|-1} s[i] * \textit{base}^{|s|-i-1},$$
å…¶ä¸­ $base$ ä¸ºé€‰å®šçš„è¿›åˆ¶å•ä½ã€‚ä¾‹å¦‚ï¼Œæœ¬é¢˜ä¸­ $s$ ä»…åŒ…å« $26$ ä¸ªå°å†™å­—æ¯ï¼Œå› æ­¤ $base$ å¯å–ä¸€ä¸ªå¤§äº $26$ çš„æ•°ï¼ˆå¦‚ $base=31$ï¼‰ã€‚

> ğŸ‘€ ä¸¤ä¸ªå­—ç¬¦ä¸² $s$ å’Œ $t$ ç›¸ç­‰ï¼Œå½“ä¸”ä»…å½“å®ƒä»¬çš„é•¿åº¦ç›¸ç­‰ä¸”ç¼–ç å€¼ç›¸ç­‰ï¼š
    $len(s)=len(t)\ ä¸”\ encode(s) = encode(t)$

>  âš ï¸ éœ€è¦æ³¨æ„çš„æ˜¯æœ¬é¢˜åœ¨ç¼–ç å­—ç¬¦ä¸²æ—¶ä¸ **1392. æœ€é•¿å¿«ä¹å‰ç¼€** çš„å®˜æ–¹é¢˜è§£ç•¥æœ‰ä¸åŒï¼Œ  å­—ç¬¦$s[i]$ çš„ç¼–ç ä¸èƒ½ç®€å•åœ°ä»¥ $s[i]-97$ è¡¨ç¤ºï¼Œä¾‹å¦‚è¿™ä¼šå¯¼è‡´ $encode('ab') = encode('b')$ ï¼ˆåœ¨åé¢åŸºäº $prefix$ è®¡ç®—åŒºé—´ç¼–ç æ—¶ä¼šé‡åˆ°ï¼‰ï¼›å¯ä»¥ä»¥ $s[i]-97+1$ æ¥è¡¨ç¤ºï¼Œé¿å…å‰å¯¼ç¼–ç  $0$ çš„å½±å“ã€‚


&nbsp;
æ¥ä¸‹æ¥é—®é¢˜å°±è½¬åŒ–ä¸ºäº†å¦‚ä½•é¢„å¤„ç†å‡ºä¸åŒé•¿åº¦å­—ç¬¦çš„ç¼–ç è¡¨ç¤ºã€‚


å¯¹äºä»¥ $s[i]$ ç»“å°¾çš„å‰ç¼€å­—ç¬¦ä¸² $s[0,...,i]$ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å¤„ç†å‡ºå…¶ç¼–ç å€¼ï¼Œè®°ä¸º $prefix[i+1]$ã€‚ç‰¹åˆ«åœ°ï¼Œ$prefix[0]=0$ã€‚

å®¹æ˜“å¾—åˆ°ä»¥ä¸‹é€’æ¨å…³ç³»ï¼š
$$prefix[i+1] = prefix[i] * base + encode(s[i])\ .$$

åŸºäºå‰ç¼€ç¼–ç  $prefix$ï¼Œå¯å¿«é€Ÿå¾—åˆ°ä»»ä¸€åŒºé—´å­—ç¬¦çš„ç¼–ç è¡¨ç¤ºï¼š
> ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºå­—ç¬¦ä¸² $'b\textcolor{red}{ab}aab'$ å¦‚ä½•å¾—åˆ°ä¸­é—´å­—ç¬¦ $'\textcolor{red}{ab}'$ çš„ç¼–ç è¡¨ç¤ºï¼š
> $$encode('\textcolor{red}{ab}') = encode('b\textcolor{red}{ab}')- encode('b')  \times base^{2} \ .$$

$$encode(s[left,...,right]) = prefix[right+1]-prefix[left] \times base^{right-left+1}\ .$$

> ä¸ºäº†åŠ é€Ÿè¿ç®—ï¼Œä¸Šå¼ä¸­ $base^{right-left+1}$ è¿™ä¸€é¡¹å¯ä»¥é¢„å¤„ç†å‡ºä¸€ä¸ªè¡¨ç¤º $base$ è¿›åˆ¶çš„å¹‚æ¬¡æ•°ç»„ $mul$ï¼Œæ»¡è¶³
> $$mul[i] = base^{i}$$


&nbsp;

åœ¨å®é™…ç¼–ç ä¸­ï¼Œå½“å­—ç¬¦ä¸²çš„é•¿åº¦å¾ˆé•¿æ—¶ï¼Œå¯¹åº”çš„å“ˆå¸Œç¼–ç å€¼ä¹Ÿä¼šå¾ˆå¤§ï¼Œç”šè‡³ä¼šè¶…å‡ºæ•´æ•°ç±»å‹çš„èŒƒå›´ã€‚å¯¹æ­¤ï¼Œä¸€èˆ¬çš„è§£å†³æ–¹æ³•æ˜¯å¯¹å­—ç¬¦çš„ç¼–ç å€¼è¿›è¡Œå–æ¨¡ï¼ˆ$MOD$ï¼‰ï¼Œä½¿å…¶ä¿æŒåœ¨æ•´æ•°ç±»å‹çš„èŒƒå›´ä¹‹å†…ã€‚

> âš ï¸ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå–æ¨¡å¯èƒ½ä¼šå¸¦æ¥å“ˆå¸Œç¢°æ’ã€‚æœ¬é¢˜è§£æœªè€ƒè™‘å“ˆå¸Œç¢°æ’çš„å‘ç”Ÿã€‚å®é™…ä¸­ä¸ºäº†å‡å°ç¢°æ’çš„å¯èƒ½ï¼Œå¯é‡‡ç”¨åŒå“ˆå¸Œç­‰ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸¤å¥—è¿›åˆ¶å’Œæ¨¡çš„ç»„åˆæ¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œç¼–ç ï¼Œåªæœ‰ä¸¤å¥—ç¼–ç å€¼éƒ½ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬æ‰è®¤ä¸ºå­—ç¬¦ä¸²ç›¸åŒã€‚ç›¸å…³åšæ³•å¯å‚è€ƒé¢˜ç›® [1044. æœ€é•¿é‡å¤å­ä¸²](https://leetcode-cn.com/problems/longest-duplicate-substring/) çš„ [å®˜æ–¹é¢˜è§£](https://leetcode-cn.com/problems/longest-duplicate-substring/solution/zui-chang-zhong-fu-zi-chuan-by-leetcode-0i9rd/)ã€‚

---
**æ‹“å±•ï¼š**

å­—ç¬¦ä¸²å“ˆå¸Œç¼–ç æ˜¯å¤„ç†ä¸€ç³»åˆ—å­—ç¬¦ä¸²åŒ¹é…é—®é¢˜çš„é€šç”¨æ–¹æ³•ï¼ŒæŒæ¡æ¨¡æ¿å¯è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š

| é¢˜å· |  é¢˜è§£ | éš¾åº¦ |
| :-----| :---- | :----: |
| [28. å®ç° strStr()](https://leetcode-cn.com/problems/implement-strstr/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œ ã€KMPã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/implement-strstr/solution/zi-fu-chuan-ha-xi-kmp-shuang-jie-by-flix-mlq1/) | ï¼ˆå¹¶ä¸ï¼‰ç®€å• |
| [796. æ—‹è½¬å­—ç¬¦ä¸²](https://leetcode-cn.com/problems/rotate-string/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œ ã€KMPã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/rotate-string/solution/by-flix-eadi/) | ï¼ˆå¹¶ä¸ï¼‰ç®€å• |
| [214. æœ€çŸ­å›æ–‡ä¸²](https://leetcode-cn.com/problems/shortest-palindrome/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œã€KMP ã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/shortest-palindrome/solution/by-flix-be4y/) | å›°éš¾ |
| ï¼ˆæ¥è¿‘æœ¬é¢˜ï¼‰[1044. æœ€é•¿é‡å¤å­ä¸²](https://leetcode-cn.com/problems/longest-duplicate-substring/) |  [ã€ å­—ç¬¦ä¸²åŒå“ˆå¸Œ + äºŒåˆ† ã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/longest-duplicate-substring/solution/by-flix-fs5k/) | å›°éš¾ |
| ï¼ˆæ¥è¿‘æœ¬é¢˜ï¼‰[1316. ä¸åŒçš„å¾ªç¯å­å­—ç¬¦ä¸²](https://leetcode-cn.com/problems/distinct-echo-substrings/) |   [ã€ å­—ç¬¦ä¸²å“ˆå¸Œã€KMP ã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/distinct-echo-substrings/solution/by-flix-zsuj/) | å›°éš¾ |
| [1392. æœ€é•¿å¿«ä¹å‰ç¼€](https://leetcode-cn.com/problems/longest-happy-prefix/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œã€KMP ã€æŒæ¡æ¨¡æ¿ï¼Œå¿«ä¹å…¶å®å¾ˆç®€å• ğŸ¤£](https://leetcode-cn.com/problems/longest-happy-prefix/solution/by-flix-k4p3/) | å›°éš¾ |
|ï¼ˆæœ¬é¢˜ï¼‰ [2223. æ„é€ å­—ç¬¦ä¸²çš„æ€»å¾—åˆ†å’Œ](https://leetcode-cn.com/problems/sum-of-scores-of-built-strings/) |   [ã€ æš´åŠ›ã€å­—ç¬¦ä¸²ç¼–ç ã€Zå‡½æ•° ã€ä¸‰ç§è§£æ³•è¯¦è§£](https://leetcode-cn.com/problems/sum-of-scores-of-built-strings/solution/by-flix-icgi/) | å›°éš¾ |

---

&nbsp;

#### ä»£ç 

```Python3 []
class Solution:
    def sumScores(self, s: str) -> int:
        
        MOD = 10**9+7
        base = 31       # sä»…åŒ…å«å°å†™å­—æ¯ï¼Œbaseå¯å–31
        
        '''å­—ç¬¦ç¼–ç å‡½æ•°'''
        def encode(ch):
            return ord(ch) - ord('a') + 1

        n = len(s)
        # é¢„å¤„ç†å‡ºå‰ç¼€å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ å’Œ baseè¿›åˆ¶çš„å¹‚
        prefix = [0] * (n+1)    # prefix[i]: å­—ç¬¦ä¸²s[0:i]çš„å“ˆå¸Œå€¼
        mul = [1] * (n+1)       # mul[i]: base ** i
        for i in range(1, n+1):
            prefix[i] = ( prefix[i-1] * base + encode(s[i-1]) ) % MOD
            mul[i] = mul[i-1] * base % MOD
        
        ans = n                     # å­—ç¬¦ä¸²sæœ¬èº«æ»¡è¶³è¦æ±‚
        for m in range(1, n):       # æšä¸¾siçš„é•¿åº¦m
            if s[n-m] != s[0]:      # å¿«é€Ÿç®€å•åˆ¤æ–­ï¼šs[n-m]æ˜¯é•¿åº¦ä¸ºmçš„åç¼€å­—ç¬¦ä¸²çš„é¦–å­—æ¯
                continue
            left, right = 0, m + 1  # äºŒåˆ†æ¨¡æ¿
            while left < right:
                mid = (left + right) // 2
                hash_val = ( prefix[n-m+mid] - prefix[n-m] * mul[mid] % MOD + MOD ) % MOD
                if hash_val == prefix[mid]:
                    left = mid + 1      # è‹¥æˆç«‹ï¼Œå°è¯•å¢å¤§å­—ç¬¦é•¿åº¦: å¾€å³æŸ¥æ‰¾ã€bisect_rightã€‘
                else:
                    right = mid
            
            ans += left-1     # bisect_rightæœç´¢ç‰¹æ€§ï¼šleftæ­¤æ—¶å¹¶ä¸å¯è¡Œï¼Œåº”è¿”å›left-1
        
        return ans
```



&nbsp;

---

**æ–¹æ³•ä¸‰ï¼šZå‡½æ•°ï¼ˆæ‰©å±• KMPï¼‰**

æœ¬é¢˜æ°æ˜¯ Zå‡½æ•°ï¼ˆåˆç§° æ‰©å±• KMPï¼‰çš„åº”ç”¨é¢˜ã€‚
ç›¸å…³ä»‹ç»å¯å‚è€ƒï¼š
| æ¥æº |  é“¾æ¥ | æ¡ˆä¾‹å±•ç¤º |
| :-----| :---- | :----: |
|OI Wiki - Z å‡½æ•°ï¼ˆæ‰©å±• KMPï¼‰ |https://oi-wiki.org/string/z-func/ | https://personal.utdallas.edu/~besp/demo/John2010/z-algorithm.htm |


å®šä¹‰å‡½æ•° $z[i]$ è¡¨ç¤º $s$ å’Œ $s[i,..,n-1]$ï¼ˆä»¥ $s[i]$ å¼€å¤´çš„åç¼€ï¼‰çš„æœ€é•¿å…¬å…±å‰ç¼€ï¼ˆLCPï¼‰çš„é•¿åº¦ã€‚æšä¸¾ $i$ å³å¯è®¡ç®—æ¯ä¸€æ­¥çš„å¾—åˆ†ã€‚

&nbsp;


```Python3 []
class Solution:
    def sumScores(self, s: str) -> int:
        
        n = len(s)
        z = [0] * n             # zå‡½æ•°
        left, right = 0, 0      # åŒ¹é…æ®µï¼ˆZ-boxï¼‰çš„é—­åŒºé—´
        
        ans = n                 # åŠ ä¸Šsè‡ªèº«é•¿åº¦n
        for i in range(1, n):   # ä»ä¸‹æ ‡1å¼€å§‹è®¡ç®—zå‡½æ•°
            if i <= right and z[i - left] < right - i + 1:  # å½“å‰ä½ç½®å¤„äºZ-boxä¸­ï¼Œä¸”å¤„äºå¯ç¡®å®šçš„åŒ¹é…èŒƒå›´å†…ï¼ˆä¸åœ¨Z-boxè¾¹ç¼˜ï¼‰ï¼Œåˆ™æ— éœ€é‡å¤è®¡ç®—è€Œç›´æ¥å¾—å‡ºz[i]
                z[i] = z[i - left]
            else:
                z[i] = max(0, right - i + 1)    # ï¼ˆä¸Šä¸€ä¸ªï¼‰Z-boxçš„å³ç«¯å¯èƒ½ä½äºiçš„å·¦ä¾§
                while i + z[i] < n and s[z[i]] == s[i + z[i]]:  # æš´åŠ›åŒ¹é…
                    z[i] += 1                   # å…¬å…±å‰ç¼€+1
            
            if i + z[i] - 1 > right:            # Z-boxåŒºé—´éœ€æ›´æ–°
                left, right = i, i + z[i] - 1
            
            ans += z[i]     # z[i]å³æ˜¯s[i:n]ä¸sçš„æœ€é•¿å…¬ä¼—å‰ç¼€çš„é•¿åº¦
        
        return ans
```


